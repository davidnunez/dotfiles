#!/bin/bash

# Installs everything to ~/bin.

if [[ "$1" == "--help" || "$1" == "-h" ]]; then
    echo "usage: ${0##*/} [uninstall]"
    echo "Installs setup/bin tools into user's ~/bin directory."
    exit 1
fi

pushd "$(dirname "$0")" >/dev/null

# Also install .shell_control here so that bin/install
# doesn't depend on env/install having been run first.
if [[ ! -f "$HOME/.shell_control" ]]; then
    rsync -apl ../env/dot_shell_control "$HOME/.shell_control"
fi
source "$HOME/.shell_control" || echo "$(tput bold)error: ~/.shell_control not installed!$(tput sgr0)" >&2

INSTALL=1
if [[ "$1" == "uninstall" ]]; then
    INSTALL=0
fi

if [[ $INSTALL == 1 ]]; then
    run "mkdir -p '$HOME/bin'"
fi

for I in *; do
    case "$I" in
        install | update_bin | usages | ignore | README.md) ;; # don't install these files
        *)
            if [[ ! -f ignore ]] || ! grep -q "$(basename "$I")" ignore; then
                if [[ $INSTALL == 1 ]]; then
                    run "rsync -apl '$I' '$HOME/bin/$I'"
                else
                    run "rm '$HOME/bin/$I'"
                fi
            fi
            ;;
    esac
done

if [[ $INSTALL == 0 ]]; then
    run "rmdir '$HOME/bin'"
fi

if [[ $INSTALL == 1 ]]; then
    show "$HOME/bin install complete!"
else
    show "$HOME/bin uninstall complete!"
fi
