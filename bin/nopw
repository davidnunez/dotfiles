#!/bin/bash

# Enables password-less ssh TO username@remotehost FROM localhost.

if [[ -z "$1" ]]; then
	echo "usage: $0 [ssh connection options] username@remotehost" 1>&2
	exit 1
fi

function show()
{
	echo -e $'\e[1;34m' "$1" $'\e[0m'
}

KEY_TYPE="${KEY_TYPE:-rsa}"
KEY="${KEY:-id_$KEY_TYPE}"

echo
show "*** KEY_TYPE set to ${KEY_TYPE} ***"
show "*** KEY set to ${KEY} ***"
echo

function local_run()
{
	echo $'\e[1;34mlocal ==>\e[0m\e[31m' $1 $'\e[0m'
	eval "$1"
	return $?
}

set -e

[[ -d "$HOME/.ssh" ]] || local_run "mkdir -p '$HOME/.ssh'"
[[ -f "$HOME/.ssh/authorized_keys" ]] || local_run "touch '$HOME/.ssh/authorized_keys'"

if [[ ! -f "$HOME/.ssh/$KEY.pub" ]]; then
	local_run "ssh-keygen -t '$KEY_TYPE'"
	local_run "cat '$HOME/.ssh/$KEY.pub' >> '$HOME/.ssh/authorized_keys'"
fi

# SSH requires certain permissions on home directory, .ssh directory, and authorized_keys file
local_run "chmod go-w $HOME"
local_run "chmod go-rwx $HOME/.ssh"
local_run "chmod go-rwx $HOME/.ssh/authorized_keys"

echo
show "*** You will be asked for your password twice... ***"
echo

local_run "cat '$HOME/.ssh/$KEY.pub' | ssh $@ 'cat > \"$KEY.pub\"'"

ssh "$@" "bash -s" << EOF
	function remote_run()
	{
		echo $'\e[1;34mremote ==>\e[0m\e[31m' \$1 $'\e[0m'
		eval "\$1"
		return \$?
	}

	set -e
	remote_run "cd ~"
	[[ -d ".ssh" ]] || remote_run "mkdir -p .ssh"
	[[ -f ".ssh/authorized_keys" ]] || remote_run "touch .ssh/authorized_keys"
	remote_run "cat '$KEY.pub' >> .ssh/authorized_keys"
	remote_run "chmod go-w ."
	remote_run "chmod go-rwx .ssh"
	remote_run "chmod go-rwx .ssh/authorized_keys"
	[[ -f "$KEY.pub" ]] && remote_run "rm '$KEY.pub'"
EOF
