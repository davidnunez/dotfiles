#!/bin/bash

# Sets up passwordless login TO the given username@remotehost FROM the current system.

if [[ -z "$1" ]]; then
	echo "usage: $0 username@remotehost" 1>&2
	exit 1
fi

KEY_TYPE="rsa"
KEY="id_$KEY_TYPE"
if [[ -n "$2" ]]; then
	echo "using key $2"
	KEY="$2"
fi

function local_run()
{
	echo $'\e[1;34mlocal ==>\e[0m\e[31m' $1 $'\e[0m'
	eval "$1"
	return $?
}

set -e

local_run "mkdir -p ~/.ssh"
local_run "touch ~/.ssh/authorized_keys"

if [[ ! -f "$HOME/.ssh/$KEY.pub" ]]; then
	local_run "ssh-keygen -t $KEY_TYPE"
	local_run "cat ~/.ssh/$KEY.pub >> ~/.ssh/authorized_keys"
fi

local_run "chmod go-w ~/"
local_run "chmod go-rwx ~/.ssh"
local_run "chmod go-rwx ~/.ssh/authorized_keys"

echo "you will be asked for your password twice..."
local_run "scp ~/.ssh/$KEY.pub \"$1\":\"~\""

ssh "$1" "bash -s" << EOF
	function remote_run()
	{
		echo $'\e[1;34mremote ==>\e[0m\e[31m' \$1 $'\e[0m'
		eval "\$1"
		return \$?
	}

	remote_run "mkdir -p ~/.ssh"
	remote_run "touch ~/.ssh/authorized_keys"
	remote_run "cat $KEY.pub >> ~/.ssh/authorized_keys"
	remote_run "chmod go-w ~/"
	remote_run "chmod go-rwx ~/.ssh"
	remote_run "chmod go-rwx ~/.ssh/authorized_keys"
	remote_run "rm ~/$KEY.pub"
EOF
