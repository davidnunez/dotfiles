#!/bin/bash

# Run shell command with a timeout.

if [[ "$1" == "--help" || "$1" == "-h" ]]; then
	echo "usage: ${0##*/} program [-options] [seconds=3]" 1>&2
	exit 1
fi

timeout_test()
{
	CMD=$1
	TIMEOUT=$2
	if [ "$TIMEOUT" = "" ]; then
		TIMEOUT=3
	fi

	err_file=$(mktemp /temp/err_file.XXXXXXXXXX) || { echo "can not make temp" 1>&2; exit 1; }
	out_file=$(mktemp /temp/out_file.XXXXXXXXXX) || { echo "can not make temp" 1>&2; exit 1; }
	rm -f "$err_file" "$out_file" 1>/dev/null 2>&1

	eval "$CMD" 1>"$out_file" 2>"$err_file" &
	p=$!
	( sleep $TIMEOUT; kill -1 "$p" 1>/dev/null 2>&1 ) 1>/dev/null 2>&1 &
	k=$1
	wait "$p" 1>/dev/null 2>&1
	exit=$?

	case $exit in
		129)
			rm -f "$err_file" "$out_file" 1>/dev/null 2>&1
			return 1
			;;

		*)
			kill "$k"
			wait "$k" 1>/dev/null 2>&1
			;;
	esac

	ERR="$(cat "$err_file")"
	OUT="$(cat "$out_file")"
	rm -f "$err_file" "$out_file" 1>/dev/null 2>&1

	echo "$OUT"

	if [ ! "$ERR" = "" ]; then
		echo "$ERR" 1>&2
		return 1
	fi

	return 0
}

timeout_test "$@"
exit $?
