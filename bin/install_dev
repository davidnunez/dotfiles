#!/bin/bash

# Installs development environment on OS X machines.

################################################################################
# Settings
################################################################################
HOMEBREW_FORMULAS="git git-flow mpfr ruby openssl autoconf libtiff libtool cmake wget mercurial unixodbc postgresql spark ncftp cppunit tclap pcre plotutils jpeg libpng freetype fontconfig ghostscript imagemagick doxygen coreutils gnu-sed gfortran ipopt mongodb scons boost dmd yaml-cpp pidof ansible mysql unrar"
PIP_PACKAGES="ipython grin nose bson pyyaml flask pymongo fabric Pygments iniparse psycopg2 SQLAlchemy numpy pandas xlrd openpyxl BeautifulSoup suds pyzmq matplotlib pycurl publicsuffix requests jsonschema"
GEM_PACKAGES="cap_gun archive-tar-minitar bson bson_ext bundler bundler-unload childprocess cuba erector gem-wrappers jekyll jewelbox log4r lolcat mongo net-ldap rack rack-protection railsless-deploy rubygems-bundler rvm shotgun tiny_tds vagrant yajl-ruby"

################################################################################
# Utilities
################################################################################
function usage()
{
	echo "usage: $(basename $0) [-l | all | step-name ]"
	echo "options:"
	echo "    -h: show usage help"
	echo "    -l: list available step names"
	echo "    -d: dry-run"
	echo "    -f: force install, do not ask for any confirmation"
	echo "    all: executes all steps"
	echo "    step-name: execute only the given step"
	exit 0
}

function show()
{
	echo $'\e[1;34m==>\e[0m\e[31m' $1 $'\e[0m'
}

function run()
{
	show "$1"
	if [[ $DRYRUN == 0 ]]; then
		eval "$1"
		return $?
	else
		return 0
	fi
}

function abort()
{
	if [[ -n "$2" ]]; then
		run "$2"
	fi
	echo $'\e[1;31merror:' $1 $'\e[0m' >&2
	exit 1
}

function ask()
{
	if [[ $FORCE = 1 ]]; then
		REPLY='y'
		return 0
	fi
	echo -n $'\n\e[1;35m'
	read -p "$1 (y/n) [n] ... "
	echo -n $'\e[0;0m'
}

function install_brew_formula()
{
	if [[ -z "$(brew ls | grep $1)" ]]; then
		run "brew install $1"
	else
		show "brew formula $1 already installed"
	fi

	# force link the most recent versions
	run "brew unlink $1 && brew link --force --overwrite $1"
}

################################################################################
# Steps
################################################################################
function step_setup_xcode()
{
	export SELECT="select"
	if [[ -z "$(which xcode-$SELECT)" ]]; then
		abort "install Xcode Command Line Tools first"
	fi
	if [[ "$(xcode-$SELECT -print-path)" != "/Applications/Xcode.app/Contents/Developer" ]]; then
		run "sudo xcode-select -switch /Applications/Xcode.app/Contents/Developer" || abort "failed to select xcode properly"
	else
		show "Xcode already selected to /Applications/Xcode.app/Contents/Developer"
	fi
}

function step_install_homebrew()
{
	if [[ -z "$(which brew)" ]]; then
		run "ruby -e \"$(curl -fsSL https://raw.github.com/Homebrew/homebrew/go/install)\""
	else
		show "Homebrew already installed"
	fi

	if [[ -z "$(which brew)" ]]; then
		abort "failed to install Homebrew"
	fi

	run "brew update"
	run "brew upgrade"

	IFS=$" "
	for I in $HOMEBREW_FORMULAS; do
		install_brew_formula $I
	done

	# cmake's bundling utility fails in completely reasonable cases, the following steps are necessary
	run "chmod +w /usr/local/Cellar/freetds/*/lib/*.dylib 2>/dev/null"
	run "chmod +w /usr/local/Cellar/pcre/*/lib/*.dylib 2>/dev/null"
	
	# install glibtool and glibtoolize as the defaults
	run "ln -sf /usr/local/bin/glibtool /usr/local/bin/libtool"
	run "ln -sf /usr/local/bin/glibtoolize /usr/local/bin/libtoolize"

	# The gfortran formula doesn't symlink libraries into /usr/local/lib, do it manually.
	local LIBGFORTRAN="$(brew ls -v gfortran | grep libgfortran.a | egrep -m 1 -v "x86_64|i386")"
	if [[ $? == 0 ]]; then
		ln -sf "$LIBGFORTRAN" /usr/local/lib/.
	fi

	# install the git remote-hg helper
	ln -sf $(brew ls -v git | grep git-remote-hg) /usr/local/bin

	# unlink keg-only formulas which should not be not symlinked into /usr/local
	run "brew unlink openssl"
}

function step_install_bash()
{
	if [[ -z "$(which brew)" ]]; then
		abort "please install Homebrew first"
	fi

	run "brew update"
	if [[ -z "$(brew ls | grep bash)" ]]; then
		run "brew install bash"
	else
		run "brew upgrade bash"
	fi

	local BASH_BINARY="$(brew ls bash | grep '^.*/bin/.*bash$')"
	local INSTALLED="$(grep "$BASH_BINARY" /etc/shells)"
	if [[ "$INSTALLED" == "" ]]; then
		run "echo \"$BASH_BINARY\" | sudo tee -a /etc/shells"
	fi

	show "Please set your terminal shell to \"$BASH_BINARY\""
}

function step_install_pip
{
	if [[ -z "$(which pip)" ]]; then
		local tempdir="$(mktemp -d -t tmp.XXXXXXXXXX)" || abort "can't create temp directory"
		local cleanup="rm -rf $tempdir"
		run "cd $tempdir" || abort "can't enter temp directory" "$cleanup"
		run "curl -sO http://python-distribute.org/distribute_setup.py" || abort "install step failed" "$cleanup"
		run "sudo python distribute_setup.py" || abort "install step failed" "$cleanup"
		run "curl -sO https://raw.github.com/pypa/pip/master/contrib/get-pip.py" || abort "install step failed" "$cleanup"
		run "sudo python get-pip.py" || abort "install step failed" "$cleanup"
		run "$cleanup"
	else
		run "sudo easy_install -U pip"
	fi
	if [[ -z "$(which pip)" ]]; then
		abort "failed to install pip"
	fi

	IFS=$" "
	for I in $PIP_PACKAGES; do
		run "sudo pip install -U $I"
	done

	# Note that `pip install readline` generally DOES NOT WORK, because
	# it installs to site-packages, which come *after* lib-dynload in sys.path,
	# where readline is located.  It must be `easy_install readline`, or to a custom
	# location on your PYTHONPATH (even --user comes after lib-dyload).
	run "sudo easy_install -U readline"

	# Fix annoying ipython settings
	run "ipython profile create"
	run "perl -pi -e 's/.*confirm_exit.*/c.TerminalInteractiveShell.confirm_exit = False/' $HOME/.ipython/profile_default/ipython_config.py"
	run "perl -pi -e 's/.*display_banner.*/c.TerminalIPythonApp.display_banner = False/' $HOME/.ipython/profile_default/ipython_config.py"
}

function step_install_gem()
{
	run "yes | sudo gem install rubygems-update"
	run "yes | sudo update_rubygems"
	run "yes | sudo gem update -q --system"

	IFS=$" "
	for I in $GEM_PACKAGES; do
		run "yes | sudo gem update -q $I"
		if [[ -z "$(gem list $I | grep $I)" ]]; then
			run "yes | sudo gem install -q $I"
		fi
	done
}

function step_install_pyodbc()
{
	if [[ -n "$(pip freeze | grep pyodbc)" ]]; then
		show "a pyodbc package is already installed..."
		ask "Force re-install?"
		[[ "$REPLY" == "y" ]] || return
		run "yes | sudo pip uninstall pyodbc"
	fi

	local tempdir="$(mktemp -d -t tmp.XXXXXXXXXX)" || abort "can't create temp directory"
	local cleanup="rm -rf $tempdir"

	type git >/dev/null 2>&1 || abort "git must be installed first (brew install git)" "$cleanup"
	run "cd $tempdir" || abort "can't enter temp directory" "$cleanup"
	run "git clone https://code.google.com/p/pyodbc/" || abort "can't acquire source" "$cleanup"
	run "cd pyodbc" || abort "can't enter source directory" "$cleanup"

	# Theoretically we can just add odbc to the list, but that doesn't seem to work correctly,
	# so I've commented that line out and replaced it with a line that simply overrides to use unixODBC.
	# run "perl -pi -e \"s/append\\('iodbc'\\)/extend\\(['iodbc', 'odbc']\\)/g\" setup.py" || abort "can't apply patch to use unixODBC on OS X"
	run "perl -pi -e \"s/append\\('iodbc'\\)/extend\\(['odbc']\\)/g\" setup.py" || abort "can't apply patch to use unixODBC on OS X"

	run "sudo python setup.py build install" || abort "build or install step failed" "$cleanup"
	run "$cleanup"
}

function step_install_mongo_c_driver_071()
{
	if [[ -f "/usr/local/lib/libmongoc.a" ]]; then
		show "a mongo-c-driver is already installed..."
		ask "Force re-install?"
		[[ "$REPLY" == "y" ]] || return
	fi

	local tempdir="$(mktemp -d -t tmp.XXXXXXXXXX)" || abort "can't create temp directory"
	local cleanup="rm -rf $tempdir"
	type scons >/dev/null 2>&1 || abort "scons must be installed first (brew install scons)" "$cleanup"
	run "cd $tempdir" || abort "can't enter temp directory" "$cleanup"
	run "git clone https://github.com/mongodb/mongo-c-driver.git" || abort "can't acquire source" "$cleanup"
	run "cd mongo-c-driver" || abort "can't enter source directory" "$cleanup"
	run "git checkout v0.7.1" || abort "build step failed" "$cleanup"
	run "scons" || abort "build step failed" "$cleanup"
	run "sudo make install" || abort "build step failed" "$cleanup"
	run "$cleanup"
}

function step_install_ccache_319()
{
	if [[ -n "$(ccache -V | head -n 1 | grep 3.1.9)" ]]; then
		show "a ccache is already installed..."
		ask "Force re-install?"
		[[ "$REPLY" == "y" ]] || return
	fi

	local tempdir="$(mktemp -d -t tmp.XXXXXXXXXX)" || abort "can't create temp directory"
	local cleanup="rm -rf $tempdir"
	run "cd $tempdir" || abort "can't enter temp directory" "$cleanup"
	if [[ ! -f /tmp/.install_dev/ccache-3.1.9.tar.gz ]] ; then
		run "wget -c http://samba.org/ftp/ccache/ccache-3.1.9.tar.gz" || abort "can't acquire source" "$cleanup"
		run "cp ccache-3.1.9.tar.gz /tmp/.install_dev/ccache-3.1.9.tar.gz"
	else
		run "cp /tmp/.install_dev/ccache-3.1.9.tar.gz ."
	fi
	run "tar xvzf ccache-3.1.9.tar.gz" || abort "build step failed" "$cleanup"
	run "cd ccache-3.1.9" || abort "build step failed" "$cleanup"
	run "./configure CFLAGS=-O3 && make" || abort "build step failed" "$cleanup"
	run "sudo make install" || abort "build step failed" "$cleanup"
	run "sudo ln -fs /usr/local/bin/ccache /usr/local/bin/gcc" || abort "unable to symlink ccache" "$cleanup"
	run "sudo ln -fs /usr/local/bin/ccache /usr/local/bin/g++" || abort "unable to symlink ccache" "$cleanup"
	run "sudo ln -fs /usr/local/bin/ccache /usr/local/bin/clang" || abort "unable to symlink ccache" "$cleanup"
	run "sudo ln -fs /usr/local/bin/ccache /usr/local/bin/clang++" || abort "unable to symlink ccache" "$cleanup"
	run "$cleanup"
}

function step_install_bison_3()
{
	if [[ -n "$(bison -V | head -n 1 | grep 3.0)" ]]; then
		show "a bison 3.0 is already installed..."
		ask "Force re-install?"
		[[ "$REPLY" == "y" ]] || return
	fi

	local tempdir="$(mktemp -d -t tmp.XXXXXXXXXX)" || abort "can't create temp directory"
	local cleanup="rm -rf $tempdir"
	run "cd $tempdir" || abort "can't enter temp directory" "$cleanup"
	if [[ ! -f /tmp/.install_dev/bison-3.0.tar.gz ]] ; then
		run "wget -c http://ftp.gnu.org/gnu/bison/bison-3.0.tar.gz" || abort "can't acquire source" "$cleanup"
		run "cp bison-3.0.tar.gz /tmp/.install_dev/bison-3.0.tar.gz"
	else
		run "cp /tmp/.install_dev/bison-3.0.tar.gz ."
	fi
	run "tar zfx bison-3.0.tar.gz" || abort "build step failed" "$cleanup"
	run "cd bison-3.0" || abort "build step failed" "$cleanup"
		run "./configure --prefix=/usr CFLAGS=-O3 && make" || abort "build step failed" "$cleanup"
		run "sudo make install" || abort "build step failed" "$cleanup"
	run "$cleanup"
}

function step_install_flex_2537()
{
	if [[ -n "$(flex -V | head -n 1 | grep 2.5.37)" ]]; then
		show "a flex 2.5.37 is already installed..."
		ask "Force re-install?"
		[[ "$REPLY" == "y" ]] || return
	fi

	local tempdir="$(mktemp -d -t tmp.XXXXXXXXXX)" || abort "can't create temp directory"
	local cleanup="rm -rf $tempdir"
	run "cd $tempdir" || abort "can't enter temp directory" "$cleanup"
	if [[ ! -f /tmp/.install_dev/flex-2.5.37.tar.gz ]] ; then
		run "wget -c http://hivelocity.dl.sourceforge.net/project/flex/flex-2.5.37.tar.gz" || abort "can't acquire source" "$cleanup"
		run "cp flex-2.5.37.tar.gz /tmp/.install_dev/flex-2.5.37.tar.gz"
	else
		run "cp /tmp/.install_dev/flex-2.5.37.tar.gz ."
	fi
	run "tar zfx flex-2.5.37.tar.gz" || abort "build step failed" "$cleanup"
	run "cd flex-2.5.37" || abort "build step failed" "$cleanup"
		run "./configure --prefix=/usr CFLAGS=-O3 && make" || abort "build step failed" "$cleanup"
		run "sudo make install" || abort "build step failed" "$cleanup"
	run "$cleanup"
}

function step_install_xquartz_275()
{
	if type Xquartz >/dev/null 2>&1; then
		show "a Xquartz is already installed..."
		ask "Force re-install?"
		[[ "$REPLY" == "y" ]] || return
	fi

	local tempdir="$(mktemp -d -t tmp.XXXXXXXXXX)" || abort "can't create temp directory"
	local cleanup="umount /Volumes/XQuartz-2.7.5; rm -rf $tempdir"
	run "cd $tempdir" || abort "can't enter temp directory" "$cleanup"
	if [[ ! -f /tmp/.install_dev/XQuartz-2.7.5.dmg ]] ; then
		run "wget -c http://xquartz.macosforge.org/downloads/SL/XQuartz-2.7.5.dmg" || abort "can't acquire XQuartz-2.7.5.dmg" "$cleanup"
		run "cp XQuartz-2.7.5.dmg /tmp/.install_dev/XQuartz-2.7.5.dmg"
	else
		run "cp /tmp/.install_dev/XQuartz-2.7.5.dmg ."
	fi
	run "hdiutil mount XQuartz-2.7.5.dmg" || abort "can't mount XQuartz-2.7.5.dmg on /Volumes/XQuartz-2.7.5" "$cleanup"
	run "sudo installer -pkg /Volumes/XQuartz-2.7.5/XQuartz.pkg -target /" || abort "installer failed" "$cleanup"
	run "$cleanup"
}

################################################################################
# Main
################################################################################
OPTIND=1
LISTING=0
FORCE=0
ALL=0
DRYRUN=0
while getopts "hlfd" opt; do
	case "$opt" in
		h) usage;;
		l) LISTING=1;;
		f) FORCE=1;;
		d) DRYRUN=1;;
	esac
done
shift $((OPTIND - 1))

if [[ $LISTING == 0 && -z "$1" ]]; then
	usage
fi

[[ $1 == all ]] && ALL=1

echo "$(tput bold)NOTE: This script is interactive, you will need to babysit it. Even in -f (force) mode you will still need to input your sudo password when asked for it.$(tput sgr0)"

if [[ $LISTING == 0 ]]; then
	echo "$(tput bold)Prerequisite: Install \"Command Line Tools\" from $(tput smul)http://developer.apple.com/downloads$(tput rmul) or X Code preferences$(tput sgr0)"
	ask "Are the \"Command Line Tools\" installed?"
	[[ "$REPLY" == "y" ]] || exit 1
	mkdir -p /tmp/.install_dev # download cache
fi

# key; question; function
steps=("xcode;sudo xcode-select -switch /Applications/Xcode.app/Contents/Developer?;step_setup_xcode
brew;Upgrade/Install Homebrew, formulas: $HOMEBREW_FORMULAS?;step_install_homebrew
pip;Upgrade/Install Pip, packages: $PIP_PACKAGES readline?;step_install_pip
gem;Upgrade/Install gem packages: rubygems-update capistrano-v2.15.5 $GEM_PACKAGES?;step_install_gem
pyodbc;Install pyodbc (patched for unixODBC on OS X)?;step_install_pyodbc
flex;Install flex 2.5.37 from source?;step_install_flex_2537
bison;Install bison 3.0 from source?;step_install_bison_3
XQuartz;Install XQuartz 2.7.5 package?;step_install_xquartz_275
mongo;Install mongo-c-driver v0.7.1 from source?;step_install_mongo_c_driver_071
bash;Install latest version of bash from Homebrew?;step_install_bash
ccache;Install ccache 3.1.9 from source?;step_install_ccache_319")

IFS=$'\n'
let steps_taken=0
for step in $steps; do
	key="$(echo $step | cut -d';' -f1)"
	question="$(echo $step | cut -d';' -f2)"
	function="$(echo $step | cut -d';' -f3)"

	if [[ $LISTING == 1 ]]; then
		echo "$(tput bold)$key$(tput sgr0)	=> $question"
		continue
	fi

	if [[ $ALL == 0 && -z "$(echo $@ | egrep "\b$key\b")" ]]; then
			continue
	fi

	let steps_taken=$(($steps_taken + 1))
	ask "[$key] $question"
	[[ "$REPLY" == "y" ]] && eval "$function"
done

if [[ $LISTING == 0 && $steps_taken == 0 ]]; then
	abort "invalid step name(s): $@"
fi

exit 0
