#!/bin/bash

# Easy way to quickly manage temporary web shares.

usage()
{
    echo "usage ${0##*/} [<file>|ls|names|ssh|get <name>|put <file>|rm <name>]" 1>&2
    echo "Requires ~/.webshare script be created for your webshare configuration."
    echo
    echo "The ~/.webshare script must set environment variables:"
    echo " * USER - user to use when connecting to HOST"
    echo " * HOST - the hostname to connect to"
    echo " * DEST_ROOT - the root of the www_html directory on HOST"
    echo " * DEST_DIR - the shares directory within the www_html directory"
    exit 1
}

[[ -f "$HOME/.webshare" ]] || usage
source "$HOME/.webshare"

DEST="$DEST_ROOT/$DEST_DIR"
BASE_URL="http://$HOST/$DEST_DIR"

share_put()
{
    FILE="$1"
    NAME="$(basename "$FILE")"
    rsync -v --chmod=a+r --rsh="ssh -c blowfish" "$FILE" "$USER"@"$HOST":"$DEST/$NAME"
    echo "$BASE_URL/$NAME"
}

list_files()
{
    # Note that we do want to expand $DEST locally here.
    local cmd="find $DEST -maxdepth 1 -type f -not -name '.*' -not -name index.php -print0 | xargs -0 ls -1tr"
    ssh "$USER"@"$HOST" "$cmd"
}

[[ -n "$1" ]] || usage

# shortcut for put
if [[ -f "$1" ]]; then
    share_put "$1"
    exit 0
fi

case "$1" in
    help|-h|--help|h*|-*)
        usage
        ;;

    names|n*)
        if [[ -n "$(echo "$*" | egrep -- "-p|--private")" ]]; then
            DEST="$DEST/private"
            BASE_URL="$BASE_URL/private"
        fi
        list_files | sed "s@$DEST/@@g"
        ;;

    list|ls|l|ll|find|f|l*|f*)
        if [[ -n "$(echo "$*" | egrep -- "-p|--private")" ]]; then
            DEST="$DEST/private"
            BASE_URL="$BASE_URL/private"
        fi
        list_files | sed "s@$DEST/@$BASE_URL/@g"
        ;;

    put|p|up|p*|u*)
        [[ -n "$2" ]] || usage
        if [[ -n "$(echo "$2" | egrep -- "-p|--private")" ]]; then
            shift
            DEST="$DEST/private"
            BASE_URL="$BASE_URL/private"
        fi
        share_put "$2"
        ;;

    get|g*)
        [[ -n "$2" ]] || usage
        if [[ -n "$(echo "$2" | egrep -- "-p|--private")" ]]; then
            shift
            DEST="$DEST/private"
            BASE_URL="$BASE_URL/private"
        fi
        NAME="$2"
        scp "$USER"@"$HOST":"$DEST/$NAME" .
        ;;

    ssh|open|shell|s*)
        ssh "$USER"@"$HOST"
        ;;

    del|delete|rm)
        [[ -n "$2" ]] || usage
        if [[ -n "$(echo "$2" | egrep -- "-p|--private")" ]]; then
            shift
            DEST="$DEST/private"
            BASE_URL="$BASE_URL/private"
        fi
        NAME="$2"
        ssh "$USER"@"$HOST" "rm -fv $DEST/$NAME"
        ;;
esac
