#!/bin/bash

# Install applications and development environment on an OS X machine.

################################################################################
# Settings
################################################################################

HOMEBREW_FORMULAS="                                                           \
    autoconf boost caskroom/cask/brew-cask cmake coreutils cppunit dmd        \
    doxygen fontconfig freetype geoip ghostscript git gnu-sed imagemagick     \
    jbig2dec jhead jpeg jq libevent libmpc libpng libtiff libtool libyaml     \
    little-cms2 maven memcached mercurial mongodb ncftp node openssl          \
    ossp-uuid pandoc pcre pidof pkg-config plotutils pngquant postgresql      \
    readline ruby s3cmd scons shellcheck sloccount spark sqlite tree unixodbc \
    unrar watch wget xz yaml-cpp youtube-dl"

HOMEBREW_CASKS="                                                              \
    adium amazon-music atom audacity caffeine caskroom/versions/java7         \
    chromecast clamxav dbvisualizer disk-inventory-x dropbox evernote firefox \
    flux gimp-lisanet google-chrome google-hangouts graphviz hipchat          \
    intellij-idea istumbler iterm2 kaleidoscope kvirc mactex mysqlworkbench   \
    pdftk pycharm robomongo silverlight skype snes9x soundflower sourcetree   \
    spotify steam teamviewer transmission vlc xquartz"

ATOM_PACKAGES="                                                               \
    atom-soda-dark-ui autocomplete-plus highlight-selected linter             \
    linter-flake8 linter-shellcheck merge-conflicts minimap minimap-git-diff  \
    minimap-selection monokai-soda next-occurrence red-wavy-underline         \
    set-syntax sort-lines tab-control tabs-to-spaces select-line              \
    rainbow-selection"

PIP_PACKAGES="                                                                \
    beautifulsoup4 bson fabric flake8 google-api-python-client httplib2       \
    iniparse oauth2client pep8 psycopg2 pyflakes pymongo pytz requests suds   \
    termcolor tinycss uritemplate"

CONDA_PACKAGES="                                                              \
    dateutil pyzmq argcomplete"

GEM_PACKAGES="                                                                \
    cap_gun archive-tar-minitar bson bson_ext bundler bundler-unload          \
    childprocess cuba erector gem-wrappers jekyll jewelbox log4r lolcat mongo \
    net-ldap rack rack-protection railsless-deploy rubygems-bundler rvm       \
    shotgun yajl-ruby capistrano"

# A useful function for cleaning up the above item lists.
cleanup_item_list()
{
    local items_var lines leftover
    declare -a lines
    items_var="$1"
    IFS=$'\n'
    lines=("$items_var=\"")
    lines+=($(eval "echo \$$items_var"  \
        | sed "s/  */ /g;s/^ *//g;"     \
        | fold -w 74 -s                 \
        | sed 's/^/    /g'))
    for ((n=0;n<${#lines[@]};n++)); do
        line="${lines[$n]}"
        leftover="$((80 - ${#line} - 2))"
        echo -n "$line"
        if [[ $((n + 1)) != ${#lines[@]} ]]; then
            for ((i=1;i<=leftover;i++)); do
                echo -n ' '
            done
            echo "\\"
        else
            echo "\""
        fi
    done
    echo
}

################################################################################
# Utilities
################################################################################
show_items()
{
    echo "$1: $(echo "$2" | sed "s/^ *//g;s/  */, /g")" | fold -w 80 -s
    echo
}

usage()
{
    (
        echo "usage: ${0##*/} [-l|-d|-f|-h|--help] [all|step-name(s)]"
        echo "Automatically installs and configures a complete OS X developer environment."
        echo
        echo "options:"
        (
            echo "    -h, --help: show usage help"
            echo "    -l: list available step names"
            echo "    -d: dry-run"
            echo "    -f: force install, do not ask for any confirmation"
            echo "    all: executes all steps"
            echo "    step-name(s): execute the given step(s)"
        ) | column -ts:
        echo
        echo "steps:"
        "$0" -l | sed 's/^/    /g'
        echo
        show_items "Homebrew Formulas" "$HOMEBREW_FORMULAS"
        show_items "Homebrew Casks" "$HOMEBREW_CASKS"
        show_items "Atom Packages" "$ATOM_PACKAGES"
        show_items "Pip Packages" "$PIP_PACKAGES"
        show_items "Conda Packages" "$CONDA_PACKAGES"
        show_items "Gem Packages" "$GEM_PACKAGES"
    ) >&2
    exit 1
}

source "$HOME/.shell_control" || echo "$(tput bold)error: ~/.shell_control not installed!$(tput sgr0)" >&2

################################################################################
# Step osx
################################################################################
step_osx()
{
    show "Enable repeat on keydown"
    defaults write -g ApplePressAndHoldEnabled -bool false

    show "Use current directory as default search scope in Finder"
    defaults write com.apple.finder FXDefaultSearchScope -string "SCcf"

    show "Show Path bar in Finder"
    defaults write com.apple.finder ShowPathbar -bool true

    show "Show Status bar in Finder"
    defaults write com.apple.finder ShowStatusBar -bool true

    show "Show indicator lights for open applications in the Dock"
    defaults write com.apple.dock show-process-indicators -bool true

    show "Enable AirDrop over Ethernet and on unsupported Macs running Lion"
    defaults write com.apple.NetworkBrowser BrowseAllInterfaces -bool true

    show "Set a blazingly fast keyboard repeat rate"
    defaults write NSGlobalDomain KeyRepeat -int 0.02

    show "Set a shorter Delay until key repeat"
    defaults write NSGlobalDomain InitialKeyRepeat -int 12

    show "Disable disk image verification"
    defaults write com.apple.frameworks.diskimages skip-verify -bool true &&
    defaults write com.apple.frameworks.diskimages skip-verify-locked -bool true &&
    defaults write com.apple.frameworks.diskimages skip-verify-remote -bool true

    show "Disable Safari’s thumbnail cache for History and Top Sites"
    defaults write com.apple.Safari DebugSnapshotsUpdatePolicy -int 2

    show "Enable Safari’s debug menu"
    defaults write com.apple.Safari IncludeInternalDebugMenu -bool true

    show "Disable the Ping sidebar in iTunes"
    defaults write com.apple.iTunes disablePingSidebar -bool true

    show "Add a context menu item for showing the Web Inspector in web views"
    defaults write NSGlobalDomain WebKitDeveloperExtras -bool true

    show "Show the ~/Library folder"
    chflags nohidden "$HOME/Library"

    show "Disable ping dropdowns"
    defaults write com.apple.iTunes hide-ping-dropdown true

    show "Disable app_to_run for XQuartz X11"
    defaults write org.macosforge.xquartz.X11 app_to_run /usr/bin/true

    show "Disable two finger gesture navigation on Chrome"
    defaults write com.google.Chrome AppleEnableSwipeNavigateWithScrolls -bool FALSE

    show "Disable recent items"
    defaults delete org.videolan.vlc.LSSharedFileList RecentDocuments
    defaults write org.videolan.vlc NSRecentDocumentsLimit 0
    defaults write org.videolan.vlc.LSSharedFileList RecentDocuments -dict-add MaxAmount 0
    defaults delete com.apple.QuickTimePlayerX.LSSharedFileList RecentDocuments
    defaults write com.apple.QuickTimePlayerX NSRecentDocumentsLimit 0
    defaults write com.apple.QuickTimePlayerX.LSSharedFileList RecentDocuments -dict-add MaxAmount 0

    HOST="$(uname -n)"
    query "Set hostname [$HOST]"
    if [[ -n "$REPLY" ]]; then
        sudo scutil --set HostName "$REPLY"
    fi
}

################################################################################
# Step xcode
################################################################################
step_xcode()
{
    if ! type xcode-select >/dev/null; then
        run "xcode-select --install"
    else
        if run "cc --version 2>/dev/null 1>&2"; then
            show "Xcode agreement is accepted."
        else
            show "Xcode agreement not accepted..."
            run "sudo cc --version" || abort "Xcode agreement NOT accepted"
        fi
    fi
    show "Xcode Command Line Tools are properly installed."
}

################################################################################
# Step java
################################################################################
step_java()
{
    show "Checking if java's installed..."
    run "java -version"
}

################################################################################
# Step brew
################################################################################
ensure_homebrew_updated()
{
    if [[ -z "$(which brew)" ]]; then
        abort "please install Homebrew first"
    fi

    run "brew update"
    run "brew upgrade"
}

install_brew_formula()
{
    if ! brew ls | grep -q "$1"; then
        run "brew install '$1'"
    else
        show "brew formula '$1' already installed"
    fi

    # force link the most recent versions
    run "brew unlink $1 && brew link --force --overwrite $1"
}

step_brew()
{
    if [[ -z "$(which brew)" ]]; then
        show "installing homebrew..."
        run "ruby -e \"\$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install)\""
        export PATH="$PATH:/usr/local/bin" # make sure brew is in your PATH before continuing
    else
        show "Homebrew already installed"
    fi

    if [[ -z "$(which brew)" ]]; then
        abort "failed to install Homebrew"
    fi

    ensure_homebrew_updated

    IFS=' '
    for I in $HOMEBREW_FORMULAS; do
        install_brew_formula "$I"
    done

    # cmake's bundling utility fails in completely reasonable cases, the following steps are necessary
    run "chmod +w /usr/local/Cellar/freetds/*/lib/*.dylib 2>/dev/null"
    run "chmod +w /usr/local/Cellar/pcre/*/lib/*.dylib 2>/dev/null"

    # install glibtool and glibtoolize as the defaults
    run "ln -sf /usr/local/bin/glibtool /usr/local/bin/libtool"
    run "ln -sf /usr/local/bin/glibtoolize /usr/local/bin/libtoolize"

    # install the git remote-hg helper
    run "ln -sf $(brew ls -v git | grep git-remote-hg) /usr/local/bin"

    # unlink keg-only formulas which should not be not symlinked into /usr/local
    run "brew unlink openssl readline sqlite"
}

################################################################################
# Step cask
################################################################################
install_brew_cask()
{
    if ! brew ls | grep -q "$1"; then
        run "brew cask install '$1'"
    else
        show "brew formula '$1' already installed"
    fi
}

step_cask()
{
    echo ""
    echo $'\e[38;5;51m'"$(tput bold)================================================================================$(tput sgr0)"$'\e[0m'
    echo $'\e[38;5;51m'"$(tput bold)= Installing Casks is ESPECIALLY interactive, you WILL need to babysit this!   =$(tput sgr0)"$'\e[0m'
    echo $'\e[38;5;51m'"$(tput bold)= For example, many Casks require additional manual steps after installation.  =$(tput sgr0)"$'\e[0m'
    echo $'\e[38;5;51m'"$(tput bold)================================================================================$(tput sgr0)"$'\e[0m'
    echo ""

    ensure_homebrew_updated

    IFS=' '
    for I in $HOMEBREW_CASKS; do
        install_brew_cask "$I"
    done
}

################################################################################
# Step atom
################################################################################
install_atom_pkg()
{
    local PKG="$1"
    local INSTALLED="$(apm list --installed --bare | grep "$PKG")"
    if [[ -z "$INSTALLED" ]]; then
        run "apm install $PKG" || abort "can not install package '$PKG'"
    else
        show "skipping $PKG: already installed"
    fi
}

step_atom()
{
    install_brew_cask atom || abort "can't install atom via brew-cask"
    IFS=' '
    for I in $ATOM_PACKAGES; do
        install_atom_pkg "$I"
    done
}

################################################################################
# Step zsh
################################################################################
ensure_add_shell()
{
    local BINARY="$1"
    local INSTALLED="$(grep "$BINARY" /etc/shells)"
    if [[ "$INSTALLED" == "" ]]; then
        run "echo '$BINARY' | sudo tee -a /etc/shells"
    fi
}

ensure_shell()
{
    NAME="$1"
    shift

    ensure_homebrew_updated
    for FORMULA in "$@"; do
        install_brew_formula "$FORMULA"
    done

    SHELL_BINARY="$(brew ls "$NAME" | grep "^.*/bin/.*$NAME\$")"
    ensure_add_shell "$SHELL_BINARY"

    BREW_SHELL_BINARY="$(brew --prefix)/bin/$NAME"
    ensure_add_shell "$BREW_SHELL_BINARY"
    run "chsh -s '$BREW_SHELL_BINARY' '$(whoami)'"
}

step_zsh()
{
    ensure_shell zsh zsh zsh-completions
}

################################################################################
# Step bash
################################################################################
step_bash()
{
    # Not installing formula bash-completion here, because that is installed
    # by env/install. This is to get the most up to date development version
    # with git (if able), or to install from a tarball if git is not available.
    ensure_shell bash bash
}

################################################################################
# Step python
################################################################################
step_python()
{
    # enter existing anaconda environment if it's detected
    [[ -d "$HOME/anaconda/bin" ]] && export PATH="$HOME/anaconda/bin:$PATH"

    if run "type conda >/dev/null 2>&1"; then
        run "conda update --yes --prefix '$HOME/anaconda' anaconda"
    else
        curl_output="$(mktemp -d -t tmp.XXXXXXXXXX)"
        trap 'rm -rf $curl_output' EXIT

        local latest
        latest="$(curl -s http://repo.continuum.io/archive/.files.json \
                  | jq 'to_entries | sort_by(.value.mtime) | reverse | .[].key' \
                  | grep -m 1 MacOSX-x86_64.sh)" || abort "could not find latest Anaconda installer"
        latest="http://repo.continuum.io/archive/$latest"
        show "downloading $latest ..."
        run "curl -o '$curl_output/anaconda.sh' '$latest'" || abort "could not download Anaconda installer"
        run "bash '$curl_output/anaconda.sh' -b" || abort "could not install Anaconda"

        # enter anaconda environment now that it's installed
        export PATH="$HOME/anaconda/bin:$PATH"

        # prevent conda from setting my PS1
        run "conda config --set changeps1 no"

        # get rid of Launcher.app on Desktop
        [[ -d "$HOME/Desktop/Launcher.app" ]] && run "rm -rf '$HOME/Desktop/Launcher.app'"

        run "rm -rf '$curl_output'"
    fi

    # Install python packages that don't come with Anaconda... yet!
    IFS=' '
    for I in $PIP_PACKAGES; do
        run "pip install -U $I"
    done

    # Install conda packages that don't come pre-installed with Anaconda
    for I in $CONDA_PACKAGES; do
        run "conda install -f --yes $I"
        run "conda update -f --yes $I"
    done

    # Fix annoying ipython settings
    run "ipython profile create"
    run "perl -pi -e 's/.*confirm_exit.*/c.TerminalInteractiveShell.confirm_exit = False/' $HOME/.ipython/profile_default/ipython_config.py"
    run "perl -pi -e 's/.*display_banner.*/c.TerminalIPythonApp.display_banner = False/' $HOME/.ipython/profile_default/ipython_config.py"
}

################################################################################
# Step gem
################################################################################
step_gem()
{
    run "yes | sudo gem install rubygems-update"
    run "yes | sudo update_rubygems"
    run "yes | sudo gem update -q --system"

    IFS=' '
    for I in $GEM_PACKAGES; do
        run "yes | sudo gem update -q $I"
        if ! gem list "$I" | grep -q "$I"; then
            run "yes | sudo gem install -q $I"
        fi
    done
}

################################################################################
# Step tiddlywiki
################################################################################
step_tiddlywiki()
{
    ensure_homebrew_updated
    install_brew_formula node
    run "npm install -g tiddlywiki"
    run "mkdir -p $HOME/Library/LaunchDaemons"
    run "cd $HOME"
    if [[ -d notes ]]; then
        show "$(tput smul)WARNING$(tput sgr0): NOT overwriting '$HOME/notes', assuming tiddlywiki already installed there!"
    else
        run "tiddlywiki notes --init server"
    fi

    local TIDDLYWIKI_DOMAIN="org.tiddlywiki.server"
    show "Creating $HOME/Library/LaunchDaemons/org.tiddlywiki.server.plist..."
    if [[ $DRYRUN == 0 ]]; then
        cat >"$HOME/Library/LaunchDaemons/$TIDDLYWIKI_DOMAIN.plist" <<EOF
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
    <dict>
        <key>Label</key>
        <string>$TIDDLYWIKI_DOMAIN</string>

        <key>WorkingDirectory</key>
        <string>$HOME</string>

        <key>ProgramArguments</key>
        <array>
            <string>$(which tiddlywiki)</string>
            <string>notes</string>
            <string>--server</string>
        </array>

        <key>RunAtLoad</key>
        <true/>

        <key>KeepAlive</key>
        <true/>
    </dict>
</plist>
EOF
    fi

    show "Creating /etc/launchd.conf..."
    run "echo 'setenv PATH \"/usr/bin:/bin:/usr/sbin:/sbin:/usr/local/bin\"' | sudo tee /etc/launchd.config"

    run "launchctl unload $HOME/Library/LaunchAgents/org.tiddlywiki.server.plist"
    run "launchctl load -w $HOME/Library/LaunchAgents/org.tiddlywiki.server.plist"

    show "TiddlyWiki setup at $HOME/notes"
    show "Server running at http://127.0.0.1:8080/"
}

################################################################################
# Main
################################################################################
if echo "$*" | egrep -q -- "--help|-h"; then
    usage
fi

if echo "$*" | egrep -q -- "--items"; then
    cleanup_item_list HOMEBREW_FORMULAS
    cleanup_item_list HOMEBREW_CASKS
    cleanup_item_list ATOM_PACKAGES
    cleanup_item_list PIP_PACKAGES
    cleanup_item_list CONDA_PACKAGES
    cleanup_item_list GEM_PACKAGES
    exit 0
fi

OPTIND=1
LISTING=0
FORCE=0
ALL=0
DRYRUN=0
while getopts "lfd" opt; do
    case "$opt" in
        l) LISTING=1;;
        f) FORCE=1;;
        d) DRYRUN=1;;
    esac
done
shift $((OPTIND - 1))

# export force/dryrun settings to shell control variables (see ~/.shell_control)
export SC_FORCE="$FORCE"
export SC_DRYRUN="$DRYRUN"

if [[ $LISTING == 0 && -z "$1" ]]; then
    usage
fi

[[ $1 == all ]] && ALL=1

if [[ $LISTING == 0 ]]; then
    echo ""
    echo "$(tput bold)===============================================================================$(tput sgr0)"
    echo "$(tput bold)= NOTE: This script is interactive, you will need to babysit it. Even in      =$(tput sgr0)"
    echo "$(tput bold)=     -f (force) mode you may need to input your sudo password, for example.  =$(tput sgr0)"
    echo "$(tput bold)===============================================================================$(tput sgr0)"
    echo ""
fi

# key;  question
steps=(
    "osx;           Override OS X defaults settings and configuration"
    "xcode;         Ensure that Xcode Command Line Tools are installed"
    "java;          Ensure that Apple's java for OS X is installed"
    "brew;          Ensure Homebrew installed and formulas upgraded"
    "cask;          Ensure Homebrew Casks are installed"
    "atom;          Ensure Atom installed via Homebrew Cask and apm packages are upgraded"
    "zsh;           Ensure shell is latest version of zsh from Homebrew"
    # "bash;         Ensure shell is latest version of bash from Homebrew"
    "python;        Upgrade/Install Anaconda, pip packages, and conda packages"
    "gem;           Upgrade/Install gem packages and rubygems-update package"
    "tiddlywiki;   Install and setup latest TiddlyWiki from Homebrew"
)

LISTING_OUTPUT=""

IFS=$'\n'
let steps_taken=0
for step in "${steps[@]}"; do
    key="$(echo $step | cut -d';' -f1)"
    question="$(echo $step | cut -d';' -f2 | sed 's/^ *//g')"
    function="step_$key"

    if [[ $LISTING == 1 ]]; then
        LISTING_OUTPUT="$LISTING_OUTPUT$key: $question"$'\n'
        continue
    fi

    if [[ $ALL == 0 ]] && ! echo "$*" | egrep -q "\b$key\b"; then
        continue
    fi

    let steps_taken=$((steps_taken + 1))
    ask "[$key] $question?"
    if [[ "$REPLY" == "y" ]]; then
        show "Beginning step [$key]"
        eval "$function"
    fi
done

if [[ $LISTING == 1 ]]; then
    echo -n "$LISTING_OUTPUT" | column -ts:
fi

if [[ $LISTING == 0 && $steps_taken == 0 ]]; then
    abort "invalid step name(s): $(echo "$*" | tr '\n' ' ')"
fi
